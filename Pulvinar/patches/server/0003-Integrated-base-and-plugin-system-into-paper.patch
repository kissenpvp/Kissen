From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Groldi <chniucg@gmail.com>
Date: Mon, 11 Sep 2023 00:49:19 +0200
Subject: [PATCH] Integrated base and plugin system into paper


diff --git a/src/main/java/io/papermc/paper/plugin/manager/PaperPluginInstanceManager.java b/src/main/java/io/papermc/paper/plugin/manager/PaperPluginInstanceManager.java
index 3e82ea07ca4194844c5528446e2c4a46ff4acee5..0ed5926ec3bcc68f804eee728268a22f554828f4 100644
--- a/src/main/java/io/papermc/paper/plugin/manager/PaperPluginInstanceManager.java
+++ b/src/main/java/io/papermc/paper/plugin/manager/PaperPluginInstanceManager.java
@@ -158,7 +158,13 @@ class PaperPluginInstanceManager {
     public void disablePlugins() {
         Plugin[] plugins = this.getPlugins();
         for (int i = plugins.length - 1; i >= 0; i--) {
+            // Pulvinar start
+            net.kissenpvp.core.base.KissenCore.getInstance().disable(net.kissenpvp.core.base.PluginState.PRE, plugins[i]);
+            // Pulvinar end
             this.disablePlugin(plugins[i]);
+            // Pulvinar start
+            net.kissenpvp.core.base.KissenCore.getInstance().disable(net.kissenpvp.core.base.PluginState.POST, plugins[i]);
+            // Pulvinar end
         }
     }
 
diff --git a/src/main/java/io/papermc/paper/plugin/manager/PaperPluginManagerImpl.java b/src/main/java/io/papermc/paper/plugin/manager/PaperPluginManagerImpl.java
index 097500a59336db1bbfffcd1aa4cff7a8586e46ec..44c641420cb1065b9b9218eed92a186674e6cad0 100644
--- a/src/main/java/io/papermc/paper/plugin/manager/PaperPluginManagerImpl.java
+++ b/src/main/java/io/papermc/paper/plugin/manager/PaperPluginManagerImpl.java
@@ -243,4 +243,12 @@ public class PaperPluginManagerImpl implements PluginManager, DependencyContext
     public MutableGraph<String> getInstanceManagerGraph() {
         return instanceManager.getDependencyGraph();
     }
+
+    // Pulvinar start
+    @Override
+    public void registerSetting(@NotNull net.kissenpvp.core.api.config.Option<?, ?> setting, @NotNull Plugin plugin)
+    {
+        org.bukkit.Bukkit.getKissen().getImplementation(net.kissenpvp.core.api.config.ConfigurationImplementation.class).registerSetting(plugin, setting);
+    }
+    // Pulvinar end
 }
diff --git a/src/main/java/io/papermc/paper/plugin/storage/ServerPluginProviderStorage.java b/src/main/java/io/papermc/paper/plugin/storage/ServerPluginProviderStorage.java
index cb9b13522a976b82bcb71cef486f11f4172e3e99..71b2e53b8dbaf385fa2cadf654a720c889658ab3 100644
--- a/src/main/java/io/papermc/paper/plugin/storage/ServerPluginProviderStorage.java
+++ b/src/main/java/io/papermc/paper/plugin/storage/ServerPluginProviderStorage.java
@@ -35,6 +35,9 @@ public class ServerPluginProviderStorage extends ConfiguredProviderStorage<JavaP
 
             @Override
             public boolean load(PluginProvider<JavaPlugin> provider, JavaPlugin provided) {
+                // Pulvinar start
+                net.kissenpvp.core.base.KissenCore.getInstance().load(net.kissenpvp.core.base.PluginState.PRE, provided);
+                // Pulvinar end
                 // Add it to the map here, we have to run the actual loading logic later.
                 PaperPluginManagerImpl.getInstance().loadPlugin(provided);
                 return true;
@@ -57,6 +60,9 @@ public class ServerPluginProviderStorage extends ConfiguredProviderStorage<JavaP
         try {
             provided.getLogger().info(String.format("Loading server plugin %s", provided.getPluginMeta().getDisplayName()));
             provided.onLoad();
+            // Pulvinar start
+            net.kissenpvp.core.base.KissenCore.getInstance().load(net.kissenpvp.core.base.PluginState.POST, provided);
+            // Pulvinar end
         } catch (Throwable ex) {
             // Don't mark that provider as ERRORED, as this apparently still needs to run the onEnable logic.
             provided.getSLF4JLogger().error("Error initializing plugin '%s' in folder '%s' (Is it up to date?)".formatted(provider.getFileName(), provider.getParentSource()), ex);
diff --git a/src/main/java/net/kissenpvp/pulvinar/base/PulvinarCore.java b/src/main/java/net/kissenpvp/pulvinar/base/PulvinarCore.java
new file mode 100644
index 0000000000000000000000000000000000000000..d42728840c132d180bdbd62081eda521f9eac1f6
--- /dev/null
+++ b/src/main/java/net/kissenpvp/pulvinar/base/PulvinarCore.java
@@ -0,0 +1,88 @@
+/*
+ * Copyright (C) 2023 KissenPvP
+ *
+ * This program is licensed under the Apache License, Version 2.0.
+ *
+ * This software may be redistributed and/or modified under the terms
+ * of the Apache License as published by the Apache Software Foundation,
+ * either version 2 of the License, or (at your option) any later version.
+ *
+ * This program is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES
+ * OR CONDITIONS OF ANY KIND, either express or implied. See the Apache
+ * License, Version 2.0 for the specific language governing permissions
+ * and limitations under the License.
+ *
+ * You should have received a copy of the Apache License, Version 2.0
+ * along with this program. If not, see <http://www.apache.org/licenses/LICENSE-2.0>.
+ */
+
+package net.kissenpvp.pulvinar.base;
+
+import net.kissenpvp.core.api.base.Implementation;
+import net.kissenpvp.core.api.base.plugin.KissenPlugin;
+import net.kissenpvp.core.api.networking.client.entitiy.ConsoleClient;
+import net.kissenpvp.core.base.KissenCore;
+import net.kissenpvp.pulvinar.api.base.PaperKissen;
+import org.bukkit.Bukkit;
+import org.bukkit.craftbukkit.scheduler.CraftScheduler;
+import org.bukkit.plugin.Plugin;
+import org.jetbrains.annotations.NotNull;
+
+import java.util.Map;
+import java.util.Optional;
+import java.util.UUID;
+
+// Pulvinar
+public class PulvinarCore extends KissenCore implements PaperKissen {
+
+    @Override
+    public @NotNull Optional<KissenPlugin> getPlugin(@NotNull String plugin) {
+        return Optional.ofNullable(Bukkit.getPluginManager().getPlugin(plugin));
+    }
+
+    @Override
+    public @NotNull KissenPlugin[] getPlugins() {
+        return Bukkit.getPluginManager().getPlugins();
+    }
+
+    @Override
+    protected void loadImplementations(@NotNull Map<Class<? extends Implementation>, Implementation> loader) {
+        loader.put(net.kissenpvp.core.api.config.ConfigurationImplementation.class, new net.kissenpvp.pulvinar.config.PulvinarConfigurationImplementation());
+        super.loadImplementations(loader);
+    }
+
+    @Override
+    protected void setupDatabase(@NotNull net.kissenpvp.core.api.config.ConfigurationImplementation config, @NotNull net.kissenpvp.core.api.database.connection.DatabaseImplementation database) {
+        super.setupDatabase(config, database);
+    }
+
+    @Override
+    public int getPort() {
+        return Bukkit.getPort();
+    }
+
+    @Override
+    public boolean isOnline(@NotNull UUID uuid) {
+        return Bukkit.getPlayer(uuid)!=null;
+    }
+
+    @Override
+    public boolean isOnline(@NotNull String s) {
+        return Bukkit.getPlayer(s)!=null;
+    }
+
+    @Override
+    public @NotNull ConsoleClient getConsole() {
+        return Bukkit.getConsoleSender();
+    }
+
+    @Override
+    public void runTask(@NotNull KissenPlugin kissenPlugin, @NotNull Runnable runnable) {
+        Bukkit.getScheduler().runTask((Plugin) kissenPlugin, runnable);
+    }
+
+    @Override
+    public void runTask(@NotNull Runnable runnable, int delay, @NotNull String name) {
+        ((CraftScheduler) Bukkit.getScheduler()).scheduleInternalTask(runnable, delay, name);
+    }
+}
diff --git a/src/main/java/net/kissenpvp/pulvinar/config/PulvinarConfigurationImplementation.java b/src/main/java/net/kissenpvp/pulvinar/config/PulvinarConfigurationImplementation.java
new file mode 100644
index 0000000000000000000000000000000000000000..e1d956e9902126f17a172beaef5e83daeed110f9
--- /dev/null
+++ b/src/main/java/net/kissenpvp/pulvinar/config/PulvinarConfigurationImplementation.java
@@ -0,0 +1,72 @@
+package net.kissenpvp.pulvinar.config;
+
+import net.kissenpvp.core.api.base.plugin.KissenPlugin;
+import net.kissenpvp.core.api.config.Option;
+import net.kissenpvp.core.config.KissenConfigurationImplementation;
+import net.kissenpvp.pulvinar.database.PrivateDatabaseDns;
+import net.kissenpvp.pulvinar.database.UsePrivate;
+import org.bukkit.configuration.file.FileConfiguration;
+import org.bukkit.configuration.file.YamlConfiguration;
+import org.jetbrains.annotations.Contract;
+import org.jetbrains.annotations.NotNull;
+
+import java.io.File;
+import java.io.IOException;
+import java.util.ArrayList;
+import java.util.List;
+import java.util.Objects;
+import java.util.TreeMap;
+import java.util.function.Function;
+import java.util.stream.Collector;
+import java.util.stream.Collectors;
+
+public class PulvinarConfigurationImplementation extends KissenConfigurationImplementation {
+
+    public PulvinarConfigurationImplementation()
+    {
+        super();
+        registerInternalSetting(new UsePrivate());
+        registerInternalSetting(new PrivateDatabaseDns());
+    }
+
+    @Override
+    protected @NotNull File getFile() {
+        return new File("config", "kissen.yml");
+    }
+
+    @Override
+    protected @NotNull File getFile(@NotNull KissenPlugin plugin) {
+        return new File(plugin.getDataFolder(), "config.yml");
+    }
+
+    @Override
+    protected void load(@NotNull File file, @NotNull List<Option<?, ?>> options) {
+        FileConfiguration configuration = YamlConfiguration.loadConfiguration(file);
+        options.forEach(option -> {
+            String path = getPath(option);
+            if (configuration.contains(path)) {
+                setValue(option, Objects.requireNonNull(configuration.getObject(path, option.getConvertClass())));
+                return;
+            }
+            setDefault(option);
+        });
+    }
+
+    @Override
+    protected void write(@NotNull File file, @NotNull List<Option<?, ?>> options) throws IOException {
+        FileConfiguration configuration = YamlConfiguration.loadConfiguration(file);
+
+        options.stream().collect(getCollector()).forEach((group, optionList) -> optionList.forEach(option -> {
+            String path = getPath(option);
+            configuration.set(path, getSerialized(option));
+        }));
+
+        configuration.save(file);
+    }
+
+    @Contract(pure = true, value = "-> new")
+    private @NotNull Collector<Option<?, ?>, ?, TreeMap<String, List<Option<?, ?>>>> getCollector() {
+        Function<Option<?, ?>, String> key = option -> option.getGroup().toLowerCase();
+        return Collectors.groupingBy(key, TreeMap::new, Collectors.toCollection(ArrayList::new));
+    }
+}
diff --git a/src/main/java/net/kissenpvp/pulvinar/database/PrivateDatabaseDns.java b/src/main/java/net/kissenpvp/pulvinar/database/PrivateDatabaseDns.java
new file mode 100644
index 0000000000000000000000000000000000000000..0d9f49011d0d71161e381daf67f7d9034c923501
--- /dev/null
+++ b/src/main/java/net/kissenpvp/pulvinar/database/PrivateDatabaseDns.java
@@ -0,0 +1,26 @@
+package net.kissenpvp.pulvinar.database;
+
+import net.kissenpvp.core.api.config.options.OptionString;
+import org.jetbrains.annotations.NotNull;
+
+public class PrivateDatabaseDns extends OptionString {
+    @Override
+    public @NotNull String getGroup() {
+        return "database";
+    }
+
+    @Override
+    public @NotNull String getDescription() {
+        return "Second private sql.";
+    }
+
+    @Override
+    public @NotNull String getDefault() {
+        return "jdbc:sqlite:privatekissen.db";
+    }
+
+    @Override
+    public int getPriority() {
+        return 11;
+    }
+}
diff --git a/src/main/java/net/kissenpvp/pulvinar/database/UsePrivate.java b/src/main/java/net/kissenpvp/pulvinar/database/UsePrivate.java
new file mode 100644
index 0000000000000000000000000000000000000000..2992f55cb77bc26243d42991822c5ce73b593a10
--- /dev/null
+++ b/src/main/java/net/kissenpvp/pulvinar/database/UsePrivate.java
@@ -0,0 +1,26 @@
+package net.kissenpvp.pulvinar.database;
+
+import net.kissenpvp.core.api.config.options.OptionBoolean;
+import org.jetbrains.annotations.NotNull;
+
+public class UsePrivate extends OptionBoolean {
+    @Override
+    public @NotNull String getGroup() {
+        return "database";
+    }
+
+    @Override
+    public @NotNull String getDescription() {
+        return "\nWhether the system should utilize a private SQL database.";
+    }
+
+    @Override
+    public @NotNull Boolean getDefault() {
+        return false;
+    }
+
+    @Override
+    public int getPriority() {
+        return 10;
+    }
+}
diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 7be1222dc02738d5a12f0a6f61626df7e9339cf3..100e8829bc4167f86353c54a8510da06c552f7c4 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -192,7 +192,7 @@ import org.bukkit.event.server.ServerLoadEvent;
 
 import co.aikar.timings.MinecraftTimings; // Paper
 
-public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTask> implements ServerInfo, CommandSource, AutoCloseable {
+public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTask> implements ServerInfo, CommandSource, AutoCloseable, net.kissenpvp.core.api.base.KissenServer { // Pulvinar - impement kissen server
 
     private static MinecraftServer SERVER; // Paper
     public static final Logger LOGGER = LogUtils.getLogger();
diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index 2eb9c584cc77237f1c82d880a51a3f8b51008d73..466ac80c423fd679ecdec505c6ed863ba305cd2b 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -192,6 +192,13 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
             DedicatedServer.LOGGER.warn("To start the server with more ram, launch it as \"java -Xmx1024M -Xms1024M -jar minecraft_server.jar\"");
         }
 
+        // Pulvinar start - start system
+        net.kissenpvp.pulvinar.base.PulvinarCore pulvinarCore = new net.kissenpvp.pulvinar.base.PulvinarCore();
+        org.bukkit.Bukkit.setKissen(pulvinarCore);
+        //system start is asynchronous
+        java.util.concurrent.CompletableFuture<Void> systemStart = java.util.concurrent.CompletableFuture.runAsync(pulvinarCore::initialize);
+        // Pulvinar stop
+
         // Paper start - detect running as root
         if (io.papermc.paper.util.ServerEnvironment.userIsRootOrAdmin()) {
             DedicatedServer.LOGGER.warn("****************************");
@@ -226,6 +233,11 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
         if (this.convertOldUsers()) {
             this.getProfileCache().save(false); // Paper
         }
+
+        // Pulvinar start - wait for system start
+        systemStart.join();
+        // Pulvinar end
+
         this.getPlayerList().loadAndSaveFiles(); // Must be after convertNames
         // Paper end - fix converting txt to json file
         org.spigotmc.WatchdogThread.doStart(org.spigotmc.SpigotConfig.timeoutTime, org.spigotmc.SpigotConfig.restartOnCrash); // Paper - start watchdog thread
@@ -308,6 +320,9 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
             DedicatedServer.LOGGER.warn("To change this, set \"online-mode\" to \"true\" in the server.properties file.");
         }
 
+        // Pulvinar start
+        pulvinarCore.start();
+        // Pulvinar end
 
         if (!OldUsersConverter.serverReadyAfterUserconversion(this)) {
             return false;
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 2fa5507aa2153a05208077f9547c165a1099b5bb..afcf19544f7b7322ead89b06d612da1e4ac458df 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -550,7 +550,13 @@ public final class CraftServer implements Server {
 
         for (Plugin plugin : plugins) {
             if ((!plugin.isEnabled()) && (plugin.getDescription().getLoad() == type)) {
+                // Pulvinar start
+                net.kissenpvp.core.base.KissenCore.getInstance().enable(net.kissenpvp.core.base.PluginState.PRE, plugin);
+                // Pulvinar end
                 this.enablePlugin(plugin);
+                // Pulvinar start
+                net.kissenpvp.core.base.KissenCore.getInstance().enable(net.kissenpvp.core.base.PluginState.POST, plugin);
+                // Pulvinar end
             }
         }
 
@@ -1001,6 +1007,12 @@ public final class CraftServer implements Server {
             throw new IllegalStateException(org.bukkit.command.defaults.ReloadCommand.RELOADING_DISABLED_MESSAGE);
         }
         // Paper end - lifecycle events
+
+        // Pulvinar start - reinitialize core
+        net.kissenpvp.core.base.KissenCore currentCore = net.kissenpvp.core.base.KissenCore.getInstance();
+        currentCore.shutdown();
+        // Pulvinar end - reinitialize core
+
         org.spigotmc.WatchdogThread.hasStarted = false; // Paper - Disable watchdog early timeout on reload
         this.reloadCount++;
         this.configuration = YamlConfiguration.loadConfiguration(this.getConfigFile());
@@ -1061,6 +1073,11 @@ public final class CraftServer implements Server {
             playerMetadata.removeAll(plugin);
         }
         // Paper end
+
+        // Pulvinar start - reinitialize core
+        currentCore.initialize(); // will replace current instance by overriding static var
+        // Pulvinar end - reinitialize core
+
         this.reloadData();
         org.spigotmc.SpigotConfig.registerCommands(); // Spigot
         io.papermc.paper.command.PaperCommands.registerCommands(this.console); // Paper
@@ -1100,6 +1117,11 @@ public final class CraftServer implements Server {
         this.syncCommands(); // Refresh commands after event
         // Paper end - brigadier command API
         this.getPluginManager().callEvent(new ServerLoadEvent(ServerLoadEvent.LoadType.RELOAD));
+
+        // Pulvinar start - reinitialize core
+        currentCore.start();
+        // Pulvinar end - reinitialize core
+
         org.spigotmc.WatchdogThread.hasStarted = true; // Paper - Disable watchdog early timeout on reload
     }
 
diff --git a/src/main/java/org/bukkit/craftbukkit/scheduler/MinecraftInternalPlugin.java b/src/main/java/org/bukkit/craftbukkit/scheduler/MinecraftInternalPlugin.java
index 66bdac50130f523f9dc4379b103b7a469f9ca36b..a85e78ffeed38eee1c5ee2fc954f852e8d63341f 100644
--- a/src/main/java/org/bukkit/craftbukkit/scheduler/MinecraftInternalPlugin.java
+++ b/src/main/java/org/bukkit/craftbukkit/scheduler/MinecraftInternalPlugin.java
@@ -150,4 +150,11 @@ public class MinecraftInternalPlugin extends PluginBase {
         throw new UnsupportedOperationException("Not supported.");
     }
     // Paper end - lifecycle events
+
+    // Pulvinar start
+    @Override
+    public net.kissenpvp.core.api.base.@org.jetbrains.annotations.NotNull Kissen getKissen() {
+        return org.bukkit.Bukkit.getKissen();
+    }
+    // Pulvinar end
 }
diff --git a/src/test/java/io/papermc/paper/plugin/PaperTestPlugin.java b/src/test/java/io/papermc/paper/plugin/PaperTestPlugin.java
index 90cf0c702ca2ff9de64d9718ecba5f2d128953a6..6fa873fa797d2c2878e328bbb0e548b5949f60cf 100644
--- a/src/test/java/io/papermc/paper/plugin/PaperTestPlugin.java
+++ b/src/test/java/io/papermc/paper/plugin/PaperTestPlugin.java
@@ -150,4 +150,11 @@ public class PaperTestPlugin extends PluginBase {
         throw new UnsupportedOperationException("Not supported.");
     }
     // Paper end - lifecycle events
+
+    // Pulvinar start
+    @Override
+    public net.kissenpvp.core.api.base.@org.jetbrains.annotations.NotNull Kissen getKissen() {
+        return org.bukkit.Bukkit.getKissen();
+    }
+    // Pulvinar end
 }
